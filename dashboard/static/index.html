<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI ì½”ì¸ ë§¤ë§¤ ì‹œë®¬ë ˆì´í„°</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0b0f19;
      --panel: #12182a;
      --panel-2: #0e1423;
      --accent: #6ae3ff;
      --accent-2: #7cf29c;
      --text: #e9eef7;
      --muted: #8da2c0;
      --danger: #ff6b6b;
      --warn: #f6c744;
      --card-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Manrope', system-ui, -apple-system, sans-serif;
      background: radial-gradient(120% 120% at 10% 10%, rgba(108, 231, 255, 0.18), transparent 35%),
                  radial-gradient(120% 120% at 90% 20%, rgba(124, 242, 156, 0.14), transparent 35%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 28px 32px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 20px;
    }
    .logo-badge {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: grid;
      place-items: center;
      color: #041018;
      font-weight: 800;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    select, button {
      background: var(--panel);
      color: var(--text);
      border: 1px solid #1f2a44;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    button {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #041018;
      border: none;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(106, 227, 255, 0.35);
    }
    main {
      padding: 0 32px 36px;
      display: grid;
      gap: 16px;
    }
    .grid {
      display: grid;
      gap: 16px;
    }
    .grid.cards { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .card {
      background: var(--panel);
      border: 1px solid #1b253a;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: var(--card-shadow);
    }
    .card h3 {
      margin: 0 0 6px;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .metric {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }
    .metric .value { font-size: 28px; font-weight: 700; }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(106, 227, 255, 0.12);
      color: var(--accent);
    }
    .pill.warn { color: #f6c744; background: rgba(246, 199, 68, 0.12); }
    .pill.danger { color: var(--danger); background: rgba(255, 107, 107, 0.12); }
    .profit-pos { color: #ff6b6b; font-weight: 700; }
    .profit-neg { color: #6ab8ff; font-weight: 700; }
    .panel {
      background: var(--panel-2);
      border: 1px solid #1b253a;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 16px 18px 12px;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .panel-header h2 { margin: 0; font-size: 18px; }
    .table-wrap {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #1c2438;
      color: var(--text);
    }
    th { color: var(--muted); font-weight: 600; }
    tbody tr:hover { background: rgba(255, 255, 255, 0.02); }
    .muted { color: var(--muted); }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: #45e38a; display: inline-block; margin-right: 6px;
    }
    .hero {
      background: linear-gradient(135deg, rgba(106,227,255,0.12), rgba(124,242,156,0.12));
      border: 1px solid #1b253a;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .hero h1 { margin: 0; font-size: 22px; }
    .hero p { margin: 6px 0 0; color: var(--muted); }
    .footer-note {
      text-align: right;
      font-size: 12px;
      color: rgba(233, 238, 247, 0.4);
      margin-top: -4px;
    }
    .support-note {
      background: rgba(255, 255, 255, 0.02);
      border: 1px dashed #1f2a44;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 12px;
      color: rgba(233, 238, 247, 0.6);
      line-height: 1.3;
    }
    .support-note strong {
      color: var(--accent);
      font-size: 13px;
    }
    .md-heading {
      font-weight: 700;
      margin: 8px 0 4px;
      color: var(--accent);
    }
    .md-bullet {
      margin-left: 8px;
      color: var(--text);
    }
    .watchlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    .watch-pill {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      text-align: center;
    }
    .pie-chart {
      max-width: 240px;
      margin: 0 auto 10px;
    }
    .pie-legend {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: var(--text);
    }
    .pie-legend span {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pie-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }
    .rationale-box {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 12px;
      border: 1px solid #1c2438;
      padding: 12px 14px;
      min-height: 96px;
      font-size: 13px;
      line-height: 1.5;
      white-space: normal;
      color: rgba(233, 238, 247, 0.8);
    }
    .badge { background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 999px; font-weight: 700; }
    @media (max-width: 768px) {
      header, main { padding: 16px; }
      .panel-header { flex-direction: column; align-items: flex-start; gap: 8px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-badge">AI</div>
      <div>LLM ì½”ì¸ë§¤ë§¤</div>
      <span class="pill" id="status-pill"><span class="status-dot"></span>MCP Online</span>
    </div>
    <div class="controls">
      <span class="pill" id="sig-pill">deepseek-chat-v3.1</span>
      <button id="refresh-btn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <main>
    <div class="hero">
      <div>
        <h1>15ë¶„ ë´‰ ë”¥ì‹´ì´ í¬íŠ¸í´ë¦¬ì˜¤</h1>
        <p>Upbit ê±°ë˜ëŸ‰ top 15 ì¢…ëª© 1ì–µ KRW ê°€ìƒ ê±°ë˜  </p>
      </div>
      <div class="badge" id="run-info">ìµœê·¼ ì—…ë°ì´íŠ¸: -</div>
    </div>

    <div class="grid cards" id="metric-cards">
      <div class="card">
        <h3>ì´ìì‚° (Equity)</h3>
        <div class="metric">
          <span class="value" id="equity-value">-</span>
          <span class="pill" id="equity-change">0%</span>
        </div>
      </div>
      <div class="card">
        <h3>í˜„ê¸ˆ (KRW)</h3>
        <div class="metric"><span class="value" id="cash-value">-</span></div>
      </div>
      <div class="card">
        <h3>ì‹¤í˜„ì†ìµ</h3>
        <div class="metric">
          <span class="value" id="realized-pnl">-</span>
        </div>
      </div>
      <div class="card">
        <h3>ë³´ìœ  ì½”ì¸ ìˆ˜</h3>
        <div class="metric"><span class="value" id="holding-count">-</span></div>
      </div>
    </div>


    <div class="panel">
      <div class="panel-header">
        <h2>ë³´ìœ  í˜„í™©</h2>
        <div class="muted" id="latest-date">-</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ì‹¬ë³¼</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>í‰ë‹¨ê°€</th>
              <th>í‰ê°€ê¸ˆì•¡ (ì¶”ì •)</th>
              <th>í‰ê°€ì†ìµ</th>
              <th>ìˆ˜ìµë¥ </th>
            </tr>
          </thead>
          <tbody id="holdings-body">
            <tr><td colspan="6" class="muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±</h2>
        <div class="muted">í˜„ê¸ˆ + ë³´ìœ  ì½”ì¸ ë¹„ì¤‘</div>
      </div>
      <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:center; justify-content:center;">
        <canvas id="portfolio-chart" class="pie-chart" height="120"></canvas>
        <div class="pie-legend" id="portfolio-legend"></div>
      </div>
      <div class="muted" id="portfolio-empty" style="display:none;">ë³´ìœ  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>ê±°ë˜ ë‚´ì—­</h2>
        <div class="muted">ìµœê·¼ ë§¤ìˆ˜/ë§¤ë„ ì²´ê²°</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ì²´ê²°ì‹œê°„</th>
              <th>ì½”ì¸</th>
              <th>ì•¡ì…˜</th>
              <th>ê±°ë˜ë‹¨ê°€</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>ê±°ë˜ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody id="actions-body">
            <tr><td colspan="6" class="muted">ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>í˜„ì¬ ì£¼ì‹œ ì¤‘ì¸ ìƒìœ„ 15ì½”ì¸</h2>
        <div class="muted" id="watchlist-info">-</div>
      </div>
      <div class="watchlist-grid" id="watchlist-grid"></div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>ê²°ì • ê·¼ê±°</h2>
        <div class="muted" id="rationale-date">-</div>
      </div>
      <div class="rationale-box" id="rationale-box">ë¡œê·¸ì—ì„œ ìµœì‹  ê²°ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div class="support-note" style="text-align:center;">
      <a href="https://www.buymeacoffee.com/100_heon" target="_blank" rel="noreferrer">
        <img src="https://img.buymeacoffee.com/button-api/?text=API ë¹„ìš©..ê°ì‚¬í•©ë‹ˆë‹¤..!&emoji=ğŸ’¸&slug=100_heon&button_colour=5F7FFF&font_colour=ffffff&font_family=Poppins&outline_colour=000000&coffee_colour=FFDD00" alt="Buy me a coffee" />
      </a>
    </div>
    <div class="footer-note">made by @100_heon</div>
  </main>

  <script>
    const apiBase = window.location.origin;
    let equityChart;

    const fmtKRW = (n) => {
      if (typeof n !== "number") return "-";
      return n.toLocaleString("ko-KR", { maximumFractionDigits: 0 }) + "ì›";
    };
    const fmtSignedKRW = (n) => {
      if (typeof n !== "number") return "-";
      const sign = n > 0 ? "+" : n < 0 ? "-" : "";
      const abs = Math.abs(n);
      return `${sign}${abs.toLocaleString("ko-KR", { maximumFractionDigits: 0 })}ì›`;
    };
    const fmtPct = (n) => (n >= 0 ? "+" : "") + n.toFixed(2) + "%";
    const INITIAL_CASH_DEFAULT = 100000000;
    let initialCashBase = INITIAL_CASH_DEFAULT;
    let portfolioChart;
    const formatTimestamp = (str) => {
      if (!str) return "-";
      const hasTime = str.includes("T");
      const iso = hasTime ? str : `${str}T00:00:00`;
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return str;
      if (!hasTime) {
        return d.toLocaleDateString("ko-KR", { month: "2-digit", day: "2-digit" });
      }
      return d.toLocaleString("ko-KR", {
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    };

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function fetchLatestRationale(sig, date) {
      if (!date) return null;
      try {
        const logs = await fetchJSON(`${apiBase}/api/logs/${sig}/${date}`);
        const records = logs?.records || [];
        for (let i = records.length - 1; i >= 0; i--) {
          const entry = records[i];
          const msgs = entry?.new_messages || [];
          for (let j = msgs.length - 1; j >= 0; j--) {
            const msg = msgs[j];
            if (msg?.role === "assistant" && msg.content) {
              return { content: msg.content, timestamp: entry?.timestamp };
            }
          }
        }
      } catch (err) {
        console.warn("Failed to load rationale", err);
      }
      return null;
    }

    const signature = "deepseek-chat-v3.1";

    function renderMetrics(portfolio, latest) {
      const equityEl = document.getElementById("equity-value");
      const equityChangeEl = document.getElementById("equity-change");
      const cashEl = document.getElementById("cash-value");
      const pnlEl = document.getElementById("realized-pnl");
      const holdingCountEl = document.getElementById("holding-count");

      if (!portfolio?.records?.length) {
        equityEl.textContent = "-";
        equityChangeEl.textContent = "-";
        cashEl.textContent = "-";
        pnlEl.textContent = "-";
        holdingCountEl.textContent = "0";
        document.getElementById("run-info").textContent = "ìµœê·¼ ì—…ë°ì´íŠ¸: -";
        return;
      }
      const rows = portfolio.records;
      const last = rows[rows.length - 1];
      pnlEl.textContent = fmtKRW(last.realized_pnl || 0);
      cashEl.textContent = fmtKRW(last.cash || 0);
      pnlEl.textContent = fmtKRW(last.realized_pnl || 0);
      const holdings = latest?.positions || {};
      const count = Object.entries(holdings).filter(([k, v]) => k !== "CASH" && (v || 0) > 0).length;
      holdingCountEl.textContent = count;
      const endLabel = formatLabelDate(last.timestamp || last.date);
      document.getElementById("run-info").textContent = `ìµœê·¼ ì—…ë°ì´íŠ¸: ${endLabel}`;
    }

    const formatLabelDate = (str) => {
      if (!str) return "-";
      const hasTime = str.includes("T");
      const iso = hasTime ? str : `${str}T00:00:00`;
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return str;
      if (!hasTime) {
        return d.toLocaleDateString("ko-KR", { month: "2-digit", day: "2-digit" });
      }
      return d.toLocaleString("ko-KR", {
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    };

    let lastHoldingsKey = "";

    function renderHoldings(latest, holdingsResp) {
      const tbody = document.getElementById("holdings-body");
      const rows = holdingsResp?.holdings || [];
      const key = JSON.stringify(rows.map(({ symbol, quantity, avg_cost, last_price }) => [symbol, quantity, avg_cost, last_price]));
      if (key === lastHoldingsKey) {
        return;
      }
      lastHoldingsKey = key;
      tbody.innerHTML = "";
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="muted">ë³´ìœ  ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
        tbody.appendChild(tr);
        return;
      }
      let totalValue = 0;
      rows.forEach(({ symbol, quantity, avg_cost, last_price, value }) => {
        const tr = document.createElement("tr");
        const qtyNum = Number(quantity) || 0;
        const avgNum = Number(avg_cost) || 0;
        const lastNum = Number(last_price) || 0;
        const valNum = Number(value) || qtyNum * lastNum;
        totalValue += valNum;
        const rate = avgNum > 0 ? ((lastNum / avgNum - 1) * 100) : 0;
        const signedRate = isFinite(rate) ? rate : 0;
        const rateStr = `${signedRate >= 0 ? "+" : ""}${signedRate.toFixed(2)}%`;
        const rateClass = rate >= 0 ? "profit-pos" : "profit-neg";
        const pnl = qtyNum * (lastNum - avgNum);
        const pnlClass = pnl >= 0 ? "profit-pos" : "profit-neg";
        tr.innerHTML = `
          <td>${symbol}</td>
          <td>${qtyNum.toFixed(6)}</td>
          <td>${fmtKRW(avgNum)}</td>
          <td>${fmtKRW(valNum)} <span class="muted">(${fmtKRW(lastNum)})</span></td>
          <td class="${pnlClass}">${fmtSignedKRW(pnl)}</td>
          <td class="${rateClass}">${rateStr}</td>
        `;
        tbody.appendChild(tr);
      });
      if (typeof holdingsResp?.initial_cash === "number") {
        initialCashBase = Number(holdingsResp.initial_cash);
      }
      renderRealtimeEquity(totalValue, holdingsResp?.positions?.CASH);
      renderPortfolioChart(rows, holdingsResp?.positions?.CASH);
    }

    function renderRealtimeEquity(totalHoldingsValue, cash = 0) {
      const equityEl = document.getElementById("equity-value");
      const changeEl = document.getElementById("equity-change");
      const cashEl = document.getElementById("cash-value");
      const realtimeEquity = (Number(totalHoldingsValue) || 0) + (Number(cash) || 0);
      equityEl.textContent = fmtKRW(realtimeEquity);
      cashEl.textContent = fmtKRW(cash || 0);
      const base = Number(initialCashBase) || INITIAL_CASH_DEFAULT;
      const pct = base ? ((realtimeEquity / base) - 1) * 100 : 0;
      changeEl.textContent = fmtPct(pct);
      changeEl.className = "pill " + (pct < 0 ? "danger" : "profit-pos");
    }

    function renderPortfolioChart(holdingsRows = [], cash = 0) {
      const ctxEl = document.getElementById("portfolio-chart");
      const emptyEl = document.getElementById("portfolio-empty");
      const legendEl = document.getElementById("portfolio-legend");
      if (!ctxEl) return;
      const slices = holdingsRows.map(item => ({
        label: item.symbol || "-",
        value: Number(item.value || 0),
      }));
      const cashVal = Number(cash || 0);
      if (cashVal > 0) {
        slices.push({ label: "CASH", value: cashVal });
      }
      const total = slices.reduce((acc, cur) => acc + cur.value, 0);
      if (!total) {
        if (portfolioChart) {
          portfolioChart.destroy();
          portfolioChart = null;
        }
        emptyEl.style.display = "block";
        legendEl.style.display = "none";
        ctxEl.style.display = "none";
        return;
      }
      emptyEl.style.display = "none";
      legendEl.style.display = "flex";
      ctxEl.style.display = "block";
      const colors = [
        "#6ae3ff", "#7cf29c", "#ffb347", "#ff6b6b", "#a29bfe",
        "#fd79a8", "#ffeaa7", "#00cec9", "#fab1a0", "#55efc4"
      ];
      const labels = slices.map(s => s.label);
      const data = slices.map(s => s.value);
      if (portfolioChart) {
        portfolioChart.data.labels = labels;
        portfolioChart.data.datasets[0].data = data;
        portfolioChart.update("none");
      } else {
        portfolioChart = new Chart(ctxEl.getContext("2d"), {
          type: "doughnut",
          data: {
            labels,
            datasets: [{
              data,
              backgroundColor: labels.map((_, idx) => colors[idx % colors.length]),
              borderWidth: 1,
            }],
          },
          options: {
            cutout: "55%",
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });
      }
      legendEl.innerHTML = "";
      labels.forEach((label, idx) => {
        const pct = ((data[idx] / total) * 100) || 0;
        const item = document.createElement("span");
        item.innerHTML = `<span class="pie-dot" style="background:${colors[idx % colors.length]}"></span>${label}: ${pct.toFixed(0)}%`;
        legendEl.appendChild(item);
      });
    }

    function renderTradeHistory(actions = []) {
      const tbody = document.getElementById("actions-body");
      tbody.innerHTML = "";
      if (!actions.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="muted">ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
        tbody.appendChild(tr);
        return;
      }
      const rows = [...actions].reverse();
      rows.forEach((a) => {
        const tr = document.createElement("tr");
        const krw = Number(a.krw_delta || 0);
        const price = Number(a.fill_price || 0);
        const amt = typeof a.amount === "number" ? a.amount : (a.amount || "-");
        const actionLabel = a.action === "buy" ? "ë§¤ìˆ˜" : "ë§¤ë„";
        tr.innerHTML = `
          <td>${formatTimestamp(a.timestamp) || a.date || "-"}</td>
          <td>${a.symbol || "-"}</td>
          <td>${actionLabel}</td>
          <td>${price ? fmtKRW(price) : "-"}</td>
          <td>${amt}</td>
          <td>${fmtKRW(Math.abs(krw || 0))}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    const escapeHtml = (str = "") => str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");

    function toSimpleHtml(md = "") {
      const filtered = md
        .replace(/##\s*ë³´ìœ  í˜„í™©[\s\S]*?(?=##|$)/g, "")
        .replace(/##\s*ì‹œì¥ ë¶„ì„[\s\S]*?(?=##|$)/g, "");
      let html = escapeHtml(filtered.trim());
      html = html.replace(/(?:^|\n)## (.*)/g, (_, title) => `<div class="md-heading">${title}</div>`);
      html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      html = html.replace(/\n- (.+)/g, (_, item) => `<div class="md-bullet">â€¢ ${item}</div>`);
      html = html.replace(/\n\n/g, "<br/><br/>");
      html = html.replace(/\n/g, "<br/>");
      return html;
    }

    function renderRationale(text, timestamp) {
      const box = document.getElementById("rationale-box");
      const label = document.getElementById("rationale-date");
      let display = "-";
      if (timestamp) {
        const d = new Date(timestamp);
        if (!isNaN(d)) {
          display = d.toLocaleString("ko-KR", { month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
        } else {
          display = timestamp;
        }
      }
      label.textContent = display;
      if (text) {
        const sanitized = toSimpleHtml(text).replace(/&lt;FINISH_SIGNAL&gt;/g, "");
        box.innerHTML = sanitized;
      } else {
        box.innerHTML = "ìµœê·¼ ê²°ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì—ì´ì „íŠ¸ ì‹¤í–‰ ê¸°ë¡ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
      }
    }

    function renderWatchlist(list = []) {
      const grid = document.getElementById("watchlist-grid");
      grid.innerHTML = "";
      if (!list.length) {
        grid.innerHTML = `<div class="muted">ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      list.forEach((item) => {
        const pill = document.createElement("div");
        pill.className = "watch-pill";
        pill.textContent = item;
        grid.appendChild(pill);
      });
    }


    async function loadAll() {
      const sig = signature;
      try {
        const [portfolio, latest, holdings, actionsResp] = await Promise.all([
          fetchJSON(`${apiBase}/api/portfolio/${sig}`),
          fetchJSON(`${apiBase}/api/positions/${sig}/latest`),
          fetchJSON(`${apiBase}/api/holdings/${sig}`),
          fetchJSON(`${apiBase}/api/actions/${sig}?limit=200`).catch(() => ({ records: [] })),
        ]);
        renderMetrics(portfolio, latest);
        renderHoldings(latest, holdings);
        document.getElementById("latest-date").textContent = `Latest: ${latest?.date || "-"}`;
        const watchlist = latest?.watchlist || [];
        renderWatchlist(watchlist);
        document.getElementById("watchlist-info").textContent = `ì´ ${watchlist.length}ê°œ`;
        const rationale = await fetchLatestRationale(sig, latest?.date);
        renderRationale(rationale?.content, rationale?.timestamp || latest?.date);
        renderTradeHistory(actionsResp?.records || []);
      } catch (err) {
        console.error(err);
      }
    }

    const REFRESH_MS = 5000; // 5ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 

    (async () => {
      document.getElementById("sig-pill").textContent = signature;
      await loadAll();
      document.getElementById("refresh-btn").addEventListener("click", loadAll);
      setInterval(loadAll, REFRESH_MS);
    })();
  </script>
</body>
</html>
